<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Near Station</title>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
	</head>
	<body>
		<div id="content"></div>

		<script type="text/babel">

		
		var NearStations = React.createClass({
			render: function(){
			var nearstation = this.props.data.map(function(station){
				return(
				React.DOM.tr({},
					React.DOM.td({},station.stn),
					React.DOM.td({},station.linename),
					React.DOM.td({},station.opc),
					React.DOM.td({},station.distance)
				)
				);
			});
			var thead = React.DOM.thead({},
				React.DOM.tr({},
					React.DOM.th({},'駅名'),
					React.DOM.th({},'線名'),
					React.DOM.th({},'社名'),
					React.DOM.th({},'距離')
				)
			);
			return (
					React.DOM.table({},[thead,nearstation])
			);
			}
		});


		var Stations = React.createClass({
			getInitialState: function(){
				return {
					data: [],
					x: -1.0,
					y: -1.0
				};
			},
			nowLocation: function(){
				var options = {
					enableHighAccuracy: true,
					timeout: 5000,
					maximumAge: 0
				};
	
				function error(err) {
					console.warn('ERROR(' + err.code + '): ' + err.message);
				};
	
				navigator.geolocation.getCurrentPosition(
					(pos) => {
						this.setState({x: pos.coords.latitude});
						this.setState({y: pos.coords.longitude});
					}, error, options
				);

			},
			loadNearStationsFromServer: function(){
				this.nowLocation();
				if(this.state.x !== -1.0 && this.state.y !== -1.0){
					$.ajax({
						url: this.props.url + '?x=' + this.state.x + '&y=' + this.state.y,
						dataType: 'json',
						cache: false,
						success: function(data){
							this.setState({data: data});
						}.bind(this),
						error: function(xhr, status, err){
							console.error(this.props.url, status, err.toString());	
						}.bind(this),
					});
				}
			},
			componentDidMount: function(){
				setInterval(this.loadNearStationsFromServer, this.props.pollInterval * 5);
			},
			render: function(){
				if(this.state.data.toString() !== [].toString() ){
					return(
						<div className="Stations">
							<h1>最寄り駅リスト</h1>
							<NearStations data={this.state.data}/>
						</div>
					);
				}else{
					this.loadNearStationsFromServer();
					return(
						<div className="Stations">
							しばらくおまちください
						</div>
					);
				}
			}
		});

		ReactDOM.render(
			<Stations url="stations.php" pollInterval={500} />,
			document.getElementById('content')
		);

		</script>
	</body>
</html>
