<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Near Station</title>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
	</head>
	<body>
		<div id="content"></div>

		<script type="text/babel">

		
		var NearStations = React.createClass({
			render: function(){
			var nearstation = this.props.data.map(function(station){
				return(
				React.DOM.tr({},
					React.DOM.td({},station.stn),
					React.DOM.td({},station.linename),
					React.DOM.td({},station.distance)
				)
				);
			});
			var thead = React.DOM.thead({},
				React.DOM.tr({},
					React.DOM.th({},'駅名'),
					React.DOM.th({},'線名'),
					React.DOM.th({},'距離')
				)
			);
			return (
					React.DOM.table({},[thead,nearstation])
			);
			}
		});


		var crd;
		var Stations = React.createClass({
			nowLocation: function(){
				var options = {
					enableHighAccuracy: true,
					timeout: 5000,
					maximumAge: 0
				};
				function success(pos) {
					crd = pos.coords;
				};
	
				function error(err) {
					console.warn('ERROR(' + err.code + '): ' + err.message);
				};
	
				navigator.geolocation.getCurrentPosition(success, error, options);
				return crd;

			},
			loadNearStationsFromServer: function(){
				var crd = this.nowLocation();
				if(typeof(crd) != "undefined"){
					$.ajax({
						url: this.props.url + '?x=' + crd.latitude + '&y=' + crd.longitude,
						dataType: 'json',
						cache: false,
						success: function(data){
							this.setState({data: data});
						}.bind(this),
						error: function(xhr, status, err){
							console.error(this.props.url, status, err.toString());	
						}.bind(this)
					});
				}
			},
			componentDidMount: function(){
				this.loadNearStationsFromServer();
				setInterval(this.loadNearStationsFromServer, this.props.pollInterval);
			},
			render: function(){
				if(this.state != null ){
					return(
						<div className="Stations">
							<NearStations data={this.state.data}/>
						</div>
					);
				}else{
					return(
						<div className="Stations">
							しばらくおまちください
						</div>
					);
				}
			}
		});

		ReactDOM.render(
			<Stations url="stations.php" pollInterval={5000} />,
			document.getElementById('content')
		);

		</script>
	</body>
</html>
